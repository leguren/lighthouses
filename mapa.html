<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>lighthouses</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }

    .custom-control {
      background: white;
      border: 1px solid transparent;
      border-radius: 6px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-bottom: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      position: relative;
    }
    .custom-control:hover { background: #f5f5f5; }
    .custom-control .material-icons { font-size: 22px; color: #333; }
    .leaflet-right .leaflet-control { margin-right: 10px; }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <script type="module">
    import { loadFaros } from "./js/faros.js";

    const map = L.map("map", { zoomControl: false });

    L.tileLayer(
      "https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}{r}.png",
      {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
        subdomains: "abcd",
        maxZoom: 19
      }
    ).addTo(map);

    function setInitialView() {
      map.setView([0, 0], 2);
    }

    setInitialView();

    let farosLayer = null;
    let buffersVisible = true;
    let pointsVisible = false;

    async function inicializarMapa() {
      const result = await loadFaros(map, false);
      farosLayer = result.layer;
      farosLayer.addTo(map);

      // apagar puntos al cargar
      farosLayer.eachLayer(layer => {
        if (layer instanceof L.LayerGroup) {
          layer.eachLayer(subLayer => {
            if (!subLayer.options?.pane || subLayer.options.pane === "farosPane") {
              map.removeLayer(subLayer);
            }
          });
        }
      });
    }
    inicializarMapa();

    function createButton(iconName, title, onClick, position = "bottomright") {
      const control = L.control({ position });
      control.onAdd = function () {
        const div = L.DomUtil.create("div", "custom-control");
        div.innerHTML = '<span class="material-icons">' + iconName + "</span>";
        div.title = title;
        div.onclick = onClick;
        return div;
      };
      control.addTo(map);
      return control;
    }

    createButton("undo", "reset", () => setInitialView());
    createButton("remove", "zoom out", () => map.zoomOut());
    createButton("add", "zoom in", () => map.zoomIn());

    // botón para encender/apagar buffers
    let bufferButton = null;

    function toggleBuffers() {
      if (!farosLayer) return;

      // mostrar/ocultar buffers y círculos
      farosLayer.eachLayer(layer => {
        if (layer instanceof L.LayerGroup) {
          layer.eachLayer(subLayer => {
            if (subLayer.options?.pane === 'buffersPane' || subLayer.options?.pane === 'circlesPane') {
              if (buffersVisible) map.removeLayer(subLayer);
              else map.addLayer(subLayer);
            }
          });
        }
      });

      buffersVisible = !buffersVisible;

      const iconSpan = bufferButton.getContainer().querySelector(".material-icons");
      if (buffersVisible) {
        iconSpan.textContent = "lightbulb";
        iconSpan.style.color = "#FFD700";
      } else {
        iconSpan.textContent = "lightbulb_outline";
        iconSpan.style.color = "";
      }
    }

    bufferButton = createButton("lightbulb_outline", "turn on/off buffers", toggleBuffers, "topright");

    // botón para encender/apagar puntos
    let pointsButton = null;

    function togglePoints() {
      if (!farosLayer) return;

      farosLayer.eachLayer(layer => {
        if (layer instanceof L.LayerGroup) {
          layer.eachLayer(subLayer => {
            if (!subLayer.options?.pane || subLayer.options.pane === 'farosPane') {
              if (pointsVisible) map.removeLayer(subLayer);
              else map.addLayer(subLayer);
            }
          });
        }
      });

      pointsVisible = !pointsVisible;

      const iconSpan = pointsButton.getContainer().querySelector(".material-icons");
      iconSpan.textContent = pointsVisible ? "radio_button_checked" : "radio_button_unchecked";
      iconSpan.style.color = "";
    }

    pointsButton = createButton("radio_button_unchecked", "show/hide lighthouses", togglePoints, "topright");

  </script>
</body>
</html>
